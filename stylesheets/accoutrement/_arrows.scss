// Arrows
// ======

@include set(arrows, (
  position: top,
  offset: center,
  direction: auto,
  size: 1em,
  color: black,
  border-width: null,
  border-color: null,
));


// Arrow Base
// ----------
@mixin _arrow-base {
  content: " ";
  position: absolute;
  height: 0;
  width: 0;
  border: solid transparent;
  pointer-events: none;
}

%_arrow-base {
  @include _arrow-base;
}


// Arrow
// -----
@mixin arrow(
  $arrow: get(arrows),
  $root: relative
) {
  $arrow: _build-arrow($arrow);
  $_body: map-get($arrow, body);
  $_border: map-get($arrow, border);

  position: $root;

  &::after {
    @extend %arrow-base;
    @include output-map($_body);
  }

  &::before {
    @if $_border { @extend %arrow-base; }
    @include output-map($_border);
  }
}


// Parse Arrow
// -----------
@function _parse-arrow(
  $arrow: null
) {
  $_return: get(arrows);
  $_numbers: ();
  $_strings: ();

  @if type-of($arrow) == map {
    $_return: map-merge($_return, $arrow);
  } @else if $arrow {

    @each $val in $arrow {
      @if type-of($val) == map {
        $_return: map-merge($_return, $val);
      } @else if type-of($val) == color {
        $_return: map-merge($_return, (color: $val));
      } @else if type-of($val) == string {
        @if index(auto up down, $val) {
          $return: map-merge($_return, (direction: $val));
        } @else {
          $_strings: append($_strings, $val);
        }
      } @else if type-of($val) == number {
        $_numbers: append($_numbers, $val);
      }
    }

    $i: 1;
    @each $val in $_strings {
      $_prop: if($i == 1, position, if($i == 2, direction, offset));
      $return: map-merge($_return, ($_prop: $val));
      $i: $i + 1;
    }

    @if length($_numbers) > 0 {
      @if length($_numbers) > 1 {
        $_return: map-merge($_return, (
          offset: nth($_numbers,1),
          size: nth($_numbers,2),
        ));
      } @else {
        $_return: map-merge($_return, (
          size: nth($_numbers, 1),
        ));
      }
    }

  }

  @return $_return;
}


// Build Arrow
// -----------
@function _build-arrow(
  $arrow
) {
  $arrow: _parse-arrow($arrow);
  $_position: map-get($arrow, position);
  $_offset: map-get($arrow, offset);
  $_color: map-get($arrow, color);
  $_size: map-get($arrow, size);
  $_border-color: map-get($arrow, border-color);
  $_border-size: map-get($arrow, border-width);
  $_opposite: opposite-position($_position);

  $_offset-position: if($_position == left or $_position == right, top, left);

  @if $_offset == 'bottom' or $_offset == 'right' {
    $_offset-position: opposite-position($_offset-position);
  } @else if type-of($_offset) == "number" and $_offset != abs($_offset) {
    $_offset-position: opposite-position($_offset-position);
  }

  $_border: null;
  $_body: (
    #{$_opposite}: 100%,
    border-#{$_opposite}-color: $color,
    border-width: $size,
  );

  @if $_offset {
    @if $_offset == 'center' {
      $_body: map-merge($_body, (
        #{$_offset-position}: 50%,
        margin-#{$_offset-position}: - $_size,
      ));
    } @else if type-of($_offset) == 'string' {
      $_body: map-merge($_body, (
        #{$_offset-position}: 0,
      ));
    } @else {
      $_body: map-merge($_body, (
        #{$_offset-position}: abs($_offset),
      ));
    }
  }

  @if $_border-size and $_border-color {
    $_border-ratio: 1.5; // 1.41421356 square root of 2, rounded a bit

    $_border: map-merge($_body, (
      border-width: $_size + $_border-size * $_border-ratio,
      border-#{$_opposite}-color: $border-color,
      margin-#{$offset-position}: if($offset == 'center', 0 - $_border, 0 - $border-size * $border-ratio),
    ));
  }

  @return: (
    body: $_body,
    border: $_border,
  );
}
